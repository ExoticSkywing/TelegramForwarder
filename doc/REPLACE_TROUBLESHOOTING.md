# 替换与格式化常见问题指南（TelegramForwarder）

目标：把来源消息底部的“频道推广/联系方式”等文字替换为你自己的内容；或让文字可点击但不显示裸链。

---

## 一、前置检查（最容易忽略的开关）
- 在 `/settings`（或 `/s`）里选中你的规则并点击“应用当前规则”。
- 将 `是否启用规则` 设为“是”。
- 将 `替换模式` 设为“开启”。
- 设置 `消息格式`：
  - 需要使用 Markdown 链接时选“Markdown”。
  - 需要使用 HTML 链接时选“HTML”。
- `转发模式` 与账号权限：使用“用户模式”时，**登录的用户必须在源频道/群里**；使用“机器人模式”时，机器人必须在源频道/群里。

---

## 二、快速上手：把文字变为可点击链接（不显示 URL）

> 只匹配“文字”，不匹配表情，稳定性更好。

- Markdown 方案（消息格式需设为 Markdown）

```bash
/clear_all_replace
/replace 在花频道 [浪漫宇宙](https://t.me/nebuluxe)
/replace 茶馆 [茶馆](https://t.me/omni_stars)
/replace 投稿新鲜事 [反馈私聊](https://t.me/nebuluxe_bot)
```

- HTML 方案（消息格式需设为 HTML）

```bash
/clear_all_replace
/replace 在花频道 <a href="https://t.me/nebuluxe">浪漫宇宙</a>
/replace 茶馆 <a href="https://t.me/omni_stars">茶馆</a>
/replace 投稿新鲜事 <a href="https://t.me/nebuluxe_bot">反馈私聊</a>
```

---

## 三、源消息带“文字(链接)”或“[文字](链接)”的兼容替换

某些频道把链接嵌在文字里。可用正则一次覆盖两种格式：

```bash
/clear_all_replace
# 在花频道 → 浪漫宇宙（Markdown 链接）
/replace (?:\[在花频道\]\([^)]+\)|在花频道\s*\([^)]+\)) [浪漫宇宙](https://t.me/nebuluxe)
# 茶馆 → 茶馆（Markdown 链接）
/replace (?:\[茶馆\]\([^)]+\)|茶馆\s*\([^)]+\)) [茶馆](https://t.me/omni_stars)
# 投稿新鲜事 → 反馈私聊（Markdown 链接）
/replace (?:\[投稿新鲜事\]\([^)]+\)|投稿新鲜事\s*\([^)]+\)) [反馈私聊](https://t.me/nebuluxe_bot)
```

---

## 四、正则表达式速查与模板（重点）

为什么这条正则能“百搭”？关键在于用一个“或”规则把两种来源格式都覆盖：

```regex
(?:\[[^\]]+\]\([^)]+\)|[^\s\[]+\s*\([^)]+\))
```

- `\[[^\]]+\]\([^)]+\)`：匹配 Markdown 链接 `[文字](链接)`。
- `[^\s\[]+\s*\([^)]+\)`：匹配普通的 `文字(链接)`，`\s*` 兼容不同数量的空格。
- `(?:A|B)`：非捕获分组，表示“匹配 A 或 B”。

在实际替换中，你通常有两种需求：

1) 保留原来的“文字”，只改链接（适合“在花频道/茶馆/投稿新鲜事”等要保持不变的名字）

```bash
# 把任意“[文字](旧链接)”或“文字(旧链接)”替换为“[同样的文字](新链接)”
/replace (?:\[(.*?)\]\([^)]+\)|([^\s\[]+)\s*\([^)]+\)) [\1\2](https://t.me/your_new_link)
```

2) 同时改文字与链接（完全替换底部条目）

```bash
/replace (?:\[[^\]]+\]\([^)]+\)|[^\s\[]+\s*\([^)]+\)) [你的新文字](https://t.me/your_new_link)
```

实战建议：
- 不把表情放进“匹配内容”；不同来源表情或编码差异会导致匹配失败。
- 避免使用 `^`/`$` 锚点，跨来源/转发后可能含零宽字符，行首/行尾匹配容易失效。
- URL 使用 `[^)] +` 捕获，足以覆盖绝大多数链接场景。


提示：
- 不要把表情放进“匹配内容”中；不同来源可能使用不同的表情/编码，容易匹配失败。
- 空格可用 `\s+` 兼容不同数量的空白。
- 避免使用 `^`（行首）约束，频道转发后可能含零宽字符导致行首匹配失败。

---

## 四、排障流程（替换无效时）

1. 最小化测试（验证替换功能是否生效）
   ```bash
   /clear_all_replace
   /replace 投稿新鲜事 测试替换成功
   ```
   若能看到“测试替换成功”，说明功能正常，问题在于匹配规则；继续第 2 步。

2. 分段替换（逐步定位是哪个片段没匹配上）
   ```bash
   /replace 在花频道 浪漫宇宙
   /replace 茶馆 茶馆
   /replace 投稿新鲜事 反馈私聊
   ```
   确认每段能否触发，再逐步换成 markdown/html 链接。

3. 查看当前规则
   ```bash
   /list_replace
   ```

4. 删除/清空规则
   ```bash
   /remove_replace <序号>
   /clear_all_replace
   ```

5. 查看容器日志（定位权限/解析问题）
   ```bash
   docker-compose logs --tail=200 telegram-forwarder
   ```

---

## 五、常见症状与对应原因

- 加了规则但完全不生效：
  - 未“应用当前规则”或规则处于禁用；
  - 未开启“替换模式”；
  - 匹配文本包含表情或行首锚点导致匹配失败；
  - 账号/机器人不在源频道，读取不到消息。

- 链接以纯文本显示而不可点击：
  - `消息格式` 与替换内容不一致（Markdown 规则用在 HTML、或反之）。

- 只替换到一部分：
  - 源消息中间有不可见字符/多空格，使用 `\s+` 更稳；
  - 源消息把链接嵌入文字，需使用“三、兼容替换”的正则写法。

---

## 六、进阶：整行替换示例（不建议长期使用）

当你确信底部整行固定为“在花频道 … 茶馆 … 投稿新鲜事 …”时，可一次性整行替换：

```bash
/replace 在花频道.*投稿新鲜事.* [浪漫宇宙](https://t.me/nebuluxe) [茶馆](https://t.me/omni_stars) [反馈私聊](https://t.me/nebuluxe_bot)
```

缺点：对源消息的微小变化（空格、表情、顺序）较敏感，建议优先使用分段或兼容替换。

---

## 七、常用指令速查

```bash
/settings            # 打开设置菜单
/s                   # settings 简写
/list_replace        # 查看替换规则
/remove_replace n    # 删除第 n 条替换规则
/clear_all_replace   # 清空当前规则的替换规则
/replace_all         # 对所有规则添加替换（慎用）
```

> 实操建议：先最小化测试 → 分段替换 → 按需切换 Markdown/HTML → 若源消息含“文字(链接)”或“[文字](链接)”，用兼容正则。


